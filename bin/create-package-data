#!/usr/bin/env php
<?php
$r = 0;
$path = dirname(__FILE__);
$outputDirectory = $argv[1] ?? ".";
$root = realpath(dirname(dirname(__FILE__)) . "/src/OEBPS");
// --
function dir_get_files(string $path) : array {
	$r = false;
	
	$load = null;
	$load = function($path) use(&$load) {
		$r = [];
		if (file_exists($path) && ($resource = opendir($path))) {
			$files = [];
			$directories = [];
			while (($item = readdir($resource)) !== false) {
				if ($item !== "." && $item !== "..") {
					$item = $path . "/" . $item;
					if (is_file($item)) {
						$files[] = $item;
					} elseif (is_dir($item)) {
						$directories[] = $item;
					}
				}
			}
			sort($files);
			sort($directories);
			$r = array_merge($r, $files);
			foreach ($directories as $directory) {
				$r = array_merge($r, $load($directory));
			}
		}
		return $r;
	};
	
	$r = $load($path);
	
	return $r;
}
// --
function uuid(bool $alpha = false) : string {
	$uuid = function() {
		return sprintf("%04x%04x%04x%04x%04x%04x%04x%04x",
			mt_rand( 0, 0xffff ), mt_rand( 0, 0xffff ),
			mt_rand( 0, 0xffff ),
			mt_rand( 0, 0x0fff ) | 0x4000,
			mt_rand( 0, 0x3fff ) | 0x8000,
			mt_rand( 0, 0xffff ), mt_rand( 0, 0xffff ), mt_rand( 0, 0xffff )
		);
	};
	$r = $uuid();
	if ($alpha) {
		while (!in_array($r[0], ["a", "b", "c", "d", "e", "f"])) {
			$r = $uuid();
		}
	}
	
	return $r;
}
// --
if (!is_dir($outputDirectory)) {
	$r = 1;
	goto onError;
}
// --
$files = array_merge(
	dir_get_files($root . "/Stories"),
	dir_get_files($root . "/Planes"),
	dir_get_files($root . "/Planeswalker")
);
$manifest = [];
$spine = [];
foreach ($files as $file) {
	$base = substr($file, strlen($root) + 1);
	$uuid = uuid(true);
	$extension = pathinfo($file, PATHINFO_EXTENSION);
	if ($extension === "xhtml") {
		$manifest[] = "<item id=\"" . $uuid . "\" href=\"" . $base . "\" media-type=\"application/xhtml+xml\"/>";
		$spine[] = "<itemref idref=\"" . $uuid . "\" />";
	} elseif ($extension === "jpg") {
		$manifest[] = "<item id=\"" . $uuid . "\" href=\"" . $base . "\" media-type=\"image/jpeg\"/>";
	} elseif ($extension === "png") {
		$manifest[] = "<item id=\"" . $uuid . "\" href=\"" . $base . "\" media-type=\"image/png\"/>";
	}
}
$manifest = implode("\n", $manifest);
$spine = implode("\n", $spine);
file_put_contents($outputDirectory . "/manifest.tmp", $manifest);
file_put_contents($outputDirectory . "/spine.tmp", $spine);

onError:

exit($r);
?>
